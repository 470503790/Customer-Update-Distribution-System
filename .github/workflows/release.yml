name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOTNET_VERSION: ${{ vars.DOTNET_VERSION }}
  NODE_VERSION: ${{ vars.NODE_VERSION }}
  COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
  COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
  COS_REGION: ${{ secrets.COS_REGION }}
  COS_BUCKET: ${{ secrets.COS_BUCKET }}
  COS_PREFIX: ${{ secrets.COS_PREFIX }}

jobs:
  build-backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish backend (placeholder)
        run: echo "TODO: dotnet publish backend entry"
      - name: Package backend (placeholder)
        run: echo "TODO: zip backend release"
      - uses: actions/upload-artifact@v4
        with:
          name: backend-release
          path: backend/_publish/*.zip

  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/web
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install (placeholder)
        run: echo "TODO: pnpm install"
      - name: Build (placeholder)
        run: echo "TODO: pnpm build"
      - name: Package frontend (placeholder)
        run: echo "TODO: zip frontend dist"
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-release
          path: frontend/admin-web_*.zip

  build-client:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish agent (placeholder)
        run: echo "TODO: dotnet publish agent"
      - name: Publish tray (placeholder)
        run: echo "TODO: dotnet publish tray"
      - name: Package client (placeholder)
        shell: pwsh
        run: echo "TODO: Compress-Archive client outputs"
      - uses: actions/upload-artifact@v4
        with:
          name: client-release
          path: |
            update-agent_*.zip
            update-tray_*.zip

  upload-to-cos:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, build-client]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: Upload to COS (placeholder)
        run: echo "TODO: upload artifacts to COS using $COS_BUCKET in $COS_REGION"

  github-release:
    runs-on: ubuntu-latest
    needs: [upload-to-cos]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./release-artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-artifacts/**/**/*.zip
