# 客户分发更新系统（RCA7 服务端更新分发）｜可开发级需求文档

> 版本：V2.0（基于 V1.0 + 客户现场目录与备份/回滚规则固化）

## 0. 概述

### 0.1 系统名称
客户分发更新系统

### 0.2 系统组成
- **服务端**（.NET 8 Web API）：包管理、发布单、范围匹配、签名 URL、监控看板、审计、云存储配置。
- **管理端**（Vue）：实施/管理员使用的配置与监控界面。
- **客户端**：
  - **Windows 更新 Agent**（Windows Service）：轮询更新、下载校验、停启服务、强制备份、落盘覆盖、执行 SQL、部署 client.zip、失败回滚、上报。
  - **Windows Tray**（WinForms）：节点本地配置界面、可选更新交互（立即/延后）、手动更新、配置上报到云存储。
- **云存储**：腾讯云 COS（存更新包、节点配置文件、执行日志/诊断文件），支持签名 URL。
- **数据库**：SQL Server（业务数据与索引）。

### 0.3 更新对象与边界
- **本系统更新对象**：客户服务器部署的 **RCA7 系统（Windows 服务）**。
- **不包含**：RCA7 业务客户端更新逻辑（由 RCA7 服务自身负责）。
- **关于 client.zip**：版本包中如包含 `client.zip`，本系统仅负责将其覆盖部署到 WinForms 端更新包目录，不负责 RCA7 客户端更新流程。

### 0.4 客户现场默认目录约定（重要）
> 以下为“标准安装布局”，作为默认值；如个别客户不同，可由 Tray 配置覆盖。

- `server.zip` 目标目录：`D:/rca7/server`（Windows 服务安装位置；server.zip 覆盖此目录）
- `client.zip` 目标目录：`D:/rca7/files/package/client`（WinForms 端更新包存放位置；client.zip 覆盖此目录）
- `结构.sql`：如存在则执行
- `data.sql`：如存在则执行

### 0.5 备份目录约定（重要）
> **不论版本包中包含哪一种更新内容（server/client/sql）**，在执行任何覆盖/SQL 变更之前必须完成备份。失败时需支持“原路覆盖回来”。

- 备份根目录（默认）：`D:/rca7/backup`
- 本次版本备份目录：`D:/rca7/backup/{version}/`
- 备份内容（同一版本放一起）：
  - 服务端文件备份目录：`D:/rca7/backup/{version}/server/`（目录镜像/快照）
  - WinForms 包目录备份文件：`D:/rca7/backup/{version}/client.zip`（对 `D:/rca7/files/package/client` 打包生成）
  - 数据库备份文件：`D:/rca7/backup/{version}/data.bak`

> 版本号示例：`1.25.12.13(12521)`

---

## 1. 背景/目标

### 1.1 业务背景
客户/分店/节点独立部署 RCA7 服务端，人工更新效率低且不可追溯。需要可控分发与执行闭环：上传版本包 → 配置发布范围（客户/分店/节点/环境）→ 节点侧自动/可选执行 → 全链路可审计。

### 1.2 目标（量化）
- 人工介入次数降低 ≥ 80%。
- 发布单范围内节点更新成功率 ≥ 99%（不做网络治理前提下）。
- 100% 可追溯：发布、下载、执行、失败原因、回滚均可查询。
- 支持同一客户多环境（DEV/TEST/UAT/PROD）隔离。

### 1.3 不做什么（Out of scope）
- 不做 RCA7 业务客户端更新。
- 不做网络加速/带宽治理（仅基础重试与失败提示）。
- 不做完整 CI/CD 流水线（可预留接口）。

---

## 2. 使用者与场景

### 2.1 用户角色
- **系统管理员**：全局/客户云存储配置、客户树管理、权限与审计。
- **实施人员**：上传包、创建发布单、发布、监控、（可选）发起回滚。

### 2.2 典型场景（用户故事）
1. 实施人员上传 `1.25.12.13(12521).zip`，选择包类型“全量”，范围“客户A/PROD/全部节点”，策略“强制”，发布。
2. 节点 Agent 执行：停服务 → 备份三件套（server 目录、client 目录打包、数据库 bak）→ 覆盖 `D:/rca7/server`（若存在 server.zip）→ 执行 `结构.sql` 再 `data.sql`（存在则执行）→ 覆盖 `D:/rca7/files/package/client`（若存在 client.zip）→ 启服 → 上报。
3. 可选更新：发布单设定截止时间；节点 Tray 弹窗“立即更新/延后”，到期自动转为强制执行。
4. 停服超时：Agent 生成诊断文件上传 COS；服务端读取并展示摘要与下载链接。
5. 客户配置了自己的 COS：该客户及其门店/节点的包下载与上报全部使用客户 COS（覆盖全局）。
6. 客户侧在服务器上通过 WinForms Tray 修改节点配置并上报到 COS，管理端仅查看，不可编辑。

---

## 3. 约束

### 3.1 技术栈/平台（固定）
- 服务端：.NET 8 Web API；管理端：Vue
- 客户端：Windows 更新 Agent（Windows Service）+ Tray（WinForms）
- 云存储：腾讯云 COS（签名 URL 下载/上传）
- 数据库：SQL Server

### 3.2 业务规则（固定）
- 版本号语义：`1.25.12.13(12521)`；**不允许同版本重复发布**。
- 树结构层级固定：客户 → 分店 → 节点。
- 环境枚举固定：DEV/TEST/UAT/PROD。
- 节点鉴权：静态长期 Token，节点安装时手动绑定。
- 服务名不统一：每节点一个实例。

---

# 4) 需求澄清清单（≤10条，按影响优先级）
> 以下为已确认决策，后续设计与开发以此为准。

1. **Tray 形态**：Tray 用 WinForms 开发，可打开更新配置界面，支持手动更新。
2. **节点配置来源**：节点配置由客户服务器本地 Tray 配置并上传到云存储；服务端“节点配置管理”只读展示。
3. **落盘策略**：
   - `server.zip` 覆盖 `D:/rca7/server`，允许删除旧文件。
   - `client.zip` 覆盖 `D:/rca7/files/package/client`，允许删除旧文件。
4. **备份规则（强制）**：不论版本包包含哪种更新内容，执行前必须完成备份：
   - `D:/rca7/backup/{version}/server/`
   - `D:/rca7/backup/{version}/client.zip`
   - `D:/rca7/backup/{version}/data.bak`
   失败必须支持原路恢复。
5. **服务控制与失败上报**：RCA7 服务名不统一；停服超时/失败生成诊断文件并上传 COS，服务端读取上报文件。
6. **SQL 执行顺序**：固定 `结构.sql` → `data.sql`；存在则执行；允许仅执行其一。
7. **数据库连接配置归属**：按节点配置连接串与备份路径（默认按 0.5 的路径，可覆盖）。
8. **备份保留策略**：备份按版本目录存放，同时支持保留 N 份（按备份目录数清理，规则见附录）。
9. **强制/可选交互**：可选更新支持 Tray “一键更新/延后”；服务端可设截止时间，到期后强制。
10. **云存储配置优先级**：系统可配置全局 COS；客户可配置 COS 覆盖；客户配置生效时，该客户及其门店/节点全部使用客户 COS。

---

# 5) 业务流程（文字步骤 + 关键节点；含异常分支）

## 5.1 节点安装与绑定（静态长期 Token）
1. 管理端创建节点：选择客户/分店/环境/节点编码，生成 NodeToken（仅展示一次）。
2. 客户服务器安装 Agent + Tray。
3. Tray 首次启动进入“绑定向导”：输入 NodeCode + Env + Token。
4. 绑定成功后，Token 安全落地（建议 DPAPI）。

## 5.2 节点配置（Tray 配置并上云；服务端只读）
1. Tray 打开“更新配置界面”，配置：
   - RCA7 服务名、停启超时
   - server/client 目录（默认 `D:/rca7/server`、`D:/rca7/files/package/client`）
   - 备份根目录（默认 `D:/rca7/backup`）与保留 N
   - SQL Server 连接串、数据库名列表
2. 保存：本地校验通过后写本地配置文件。
3. 上报：申请签名上传 URL → 直传 COS → commit → 服务端写 NodeConfigIndex（索引+摘要）。

## 5.3 包上传与发布（实施人员）
1. 上传 `{version}.zip`，填写版本号、说明、选择包类型。
2. 服务端校验：版本唯一、SHA-256、解析清单（server.zip/client.zip/结构.sql/data.sql）。
3. 上传至 COS（默认全局 COS 存包）。
4. 创建发布单：范围（客户/分店/节点+环境），策略（强制/可选），可选设截止时间。

## 5.4 节点更新执行（Agent）
> Agent 执行以本地 Tray 配置为准。

**原则：执行前必须先备份三件套。**

1. 轮询拉取更新。
2. 下载版本包并校验 SHA-256。
3. 策略：强制立即；可选则 Tray 提示“立即/延后”，到期强制。
4. 停服：停止配置服务名。
   - 失败：生成诊断文件 → 上传 COS → 上报失败并结束。
5. 备份（三件套，强制）：
   - server：镜像复制 `D:/rca7/server` → `D:/rca7/backup/{version}/server/`
   - client：将 `D:/rca7/files/package/client` 打包为 `D:/rca7/backup/{version}/client.zip`
   - db：BACKUP DATABASE 输出为 `D:/rca7/backup/{version}/data.bak`
   - 备份失败：上报失败并结束（不进入覆盖/SQL）。
6. 覆盖（存在则执行）：
   - server.zip → 覆盖到 `D:/rca7/server`（允许删除旧文件；默认保护 config/logs，可配置）
   - client.zip → 覆盖到 `D:/rca7/files/package/client`（允许删除旧文件；保护路径可配置）
7. SQL（存在则执行，顺序固定）：结构.sql → data.sql（支持 GO 分批）。
8. 启服：启动服务。
9. 上报结果：状态机阶段、耗时、错误码；大日志/诊断文件上传 COS。

**回滚触发**：覆盖失败/SQL 失败/启服失败 → 进入 5.5。

## 5.5 回滚（原路覆盖回来；默认文件+数据库）
1. 停止服务。
2. 文件恢复：
   - `D:/rca7/backup/{version}/server/` → 覆盖回 `D:/rca7/server`
   - 解压 `D:/rca7/backup/{version}/client.zip` → 覆盖回 `D:/rca7/files/package/client`
3. 数据库恢复：RESTORE `D:/rca7/backup/{version}/data.bak`。
4. 启动服务。
5. 上报回滚结果。

---

# 6) 功能清单（模块→功能点→说明→优先级）

## 6.1 管理端 + 服务端
- 客户/分店/节点管理 + Token 生成【P0】
- 云存储配置：全局 + 客户覆盖优先【P0】
- 节点配置只读：索引 + 下载/预览（不可编辑）【P0】
- 更新包管理：上传、版本唯一、解析清单、最小校验（四类至少一类存在）【P0】
- 发布单：范围选择、强制/可选、可选截止时间【P0】
- 看板与审计：状态机、错误码、COS 文件索引、审计日志【P0】
- 回滚发起（对范围/节点）【P1】

## 6.2 Windows Agent（Service）
- 拉取/下载/校验【P0】
- 停服→备份三件套→覆盖 server/client→执行 SQL→启服【P0】
- 诊断文件与日志上传 COS【P0】
- 状态机断点恢复【P0】

## 6.3 WinForms Tray
- 配置 UI（默认路径固化，支持覆盖）【P0】
- 配置保存与上报【P0】
- 可选更新交互：立即/延后【P0】
- 手动更新入口【P0】

---

# 7) 数据模型与配置模型（可开发）

## 7.1 数据库核心表（沿用 V1）
- Customer / Store / Node / StorageConfig / Package / Release / ReleaseTarget / NodeConfigIndex / UpdateTask / AuditLog。

## 7.2 UpdateTask 推荐补充字段
- `BackupLocalPath`：本次实际备份目录（例如 `D:/rca7/backup/1.25.12.13(12521)/` 或带时间戳后缀），用于排查与回滚定位。
- `ServerDir`、`ClientDir`：执行时的目标目录快照（从本地配置读取）。

## 7.3 节点本地配置文件（Tray）模板（V2）
> 建议本地文件：`node-config.json`（可加密存储；上云可上传密文 + 摘要）

```json
{
  "configVersion": 202512140001,
  "service": {
    "name": "RCA7_Service_InstanceA",
    "stopTimeoutSeconds": 120,
    "startTimeoutSeconds": 120
  },
  "paths": {
    "serverDir": "D:/rca7/server",
    "clientDir": "D:/rca7/files/package/client",
    "backupRoot": "D:/rca7/backup",
    "tempDir": "D:/rca7/update_tmp",
    "protectPaths": [
      "D:/rca7/server/config",
      "D:/rca7/server/logs"
    ]
  },
  "backup": {
    "retentionN": 5,
    "db": {
      "sqlConnectionString": "Server=127.0.0.1;Database=master;User Id=sa;Password=***;TrustServerCertificate=True;",
      "databases": ["RCA7_Main"],
      "backupFileName": "data.bak"
    },
    "clientBackupFileName": "client.zip"
  },
  "deploy": {
    "deleteOldFiles": true,
    "clientDeleteOldFiles": true
  }
}
```

> 说明：文档中以 `D:/...` 表示 Windows 路径，实际落地可为 `D:\...`。

---

# 8) 接口与状态机/错误码（可开发）

## 8.1 接口（沿用 V1，关键点）
- Agent/Tray 登录与拉取：`/api/agent/auth/*`、`/api/agent/updates/latest`
- 上报：`/api/agent/updates/report`
- 文件上传两段式：`/api/agent/files/upload-url`、`/api/agent/files/commit`
- 管理端：包上传、发布单、看板、节点配置只读、云存储配置。

## 8.2 状态机（UpdateTask.Status）
- 10 Pending
- 20 Downloading
- 30 Verifying
- 40 WaitingUser（Optional）
- 50 StoppingService
- 60 BackingUp
- 70 InstallingServer
- 75 InstallingClient
- 80 RunningSql
- 90 StartingService
- 100 Succeeded
- 110 Failed
- 120 Rollbacking
- 130 Rollbacked

## 8.3 错误码（最小集）
- E_AUTH_INVALID
- E_VERSION_DUPLICATE
- E_PACKAGE_INVALID
- E_DOWNLOAD_FAILED / E_HASH_MISMATCH
- E_SERVICE_STOP_TIMEOUT / E_SERVICE_STOP_FAILED
- E_BACKUP_FAILED_SERVER / E_BACKUP_FAILED_CLIENT / E_BACKUP_FAILED_DB
- E_INSTALL_FAILED_SERVER / E_INSTALL_FAILED_CLIENT
- E_SQL_FAILED_SCHEMA / E_SQL_FAILED_DATA
- E_SERVICE_START_FAILED
- E_ROLLBACK_FAILED
- E_BACKUP_MISSING

---

# 9) 验收标准（P0）

1. **备份三件套强制**：执行任意更新前，必须生成：
   - `D:/rca7/backup/{version}/server/`（目录存在且包含镜像文件）
   - `D:/rca7/backup/{version}/client.zip`（可解压）
   - `D:/rca7/backup/{version}/data.bak`（可 restore）
2. **server.zip 覆盖路径正确**：覆盖到 `D:/rca7/server`，旧文件被删除（构造多余文件验证）。
3. **client.zip 覆盖路径正确**：覆盖到 `D:/rca7/files/package/client`，旧文件被删除。
4. **SQL 顺序正确**：存在结构.sql 与 data.sql 时固定先结构后数据；仅存在其一则只执行该文件。
5. **失败可原路恢复**：模拟 SQL 失败或启服失败，能自动回滚三件套并上报回滚状态。
6. **诊断文件上云可见**：停服失败生成诊断文件上传 COS；管理端可看到链接与摘要。

---

# 10) 风险与假设
- 固定目录在个别客户可能不同：通过 Tray 配置覆盖解决；验收覆盖默认与覆盖两种。
- client 目录打包体积可能大：压缩等级/排除规则可作为 P1。

---

# 11) 迭代计划
- MVP（P0）：按 V2 交付固定路径、三件套备份/回滚、可选交互、配置上云只读。
- P1：回滚拆分 FileOnly/DbOnly、COS 配置测试、配置自检、报表导出。

---

## 附录 A：版本包结构规范（V2）
- 外层：`{version}.zip`
- 内部（可选组合，存在则执行）：`server.zip`、`client.zip`、`结构.sql`、`data.sql`
- 最小要求：四者至少存在其一。

## 附录 B：备份与保留策略（V2）
- 默认备份目录：`{backupRoot}/{version}/`
- 若同版本目录已存在（异常重试场景）：建议新建 `{backupRoot}/{version}_{yyyyMMddHHmmss}/`，并将实际路径写入 UpdateTask.BackupLocalPath。
- 保留 N：按备份目录创建时间/命名时间戳排序，保留最近 N 个目录，删除最旧目录。

## 附录 C：覆盖算法建议（V2）
- 解压到临时目录 → 同步复制到目标目录（覆盖） → 若允许删除旧文件：删除目标目录中“本次解压内容不存在且不在 protectPaths 下”的文件/目录。

## 附录 D：SQL 执行要求（V2）
- 支持脚本包含 `GO` 分批。
- 执行日志写入 sql.log，失败需上传 COS 并在 UpdateTask.ReportFilesJson 索引。

